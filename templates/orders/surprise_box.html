{% extends 'accounts/dashboard/base_dashboard.html' %}
{% block title %}Surprise Box | Mystery Meal{% endblock %}

{% block sidebar %}
    {% url 'customer_dashboard' as dash %}{% url 'my_orders' as orders %}
    {% url 'create_reservation' as book %}{% url 'reservation_list' as res_list %}
    {% url 'add_review' as add_rev %}{% url 'my_testimonials' as my_testi %}
    {% url 'surprise_box' as surprise %}

    <a href="{{ dash }}" class="{% if request.path == dash %}active{% endif %}"><i class="fa-solid fa-chart-line"></i> Analytics</a>
    <a href="{{ orders }}" class="{% if request.path == orders %}active{% endif %}"><i class="fa-solid fa-shopping-bag"></i> My Orders</a>
    <a href="{{ book }}" class="{% if request.path == book %}active{% endif %}"><i class="fa-solid fa-calendar-plus"></i> Book Table</a>
    <a href="{{ res_list }}" class="{% if request.path == res_list %}active{% endif %}"><i class="fa-solid fa-list-ul"></i> My Reservations</a>
    <a href="{% url 'my_payments' %}" class="{% if request.path == '/accounts/dashboard/payments/' %}active{% endif %}">
        <i class="fa-solid fa-credit-card"></i> My Payments
    </a>
    
    <a href="{{ surprise }}" class="{% if request.path == surprise %}active{% endif %}" style="background: rgba(255, 193, 7, 0.1); color: #d39e00; font-weight: bold;">
        <i class="fa-solid fa-gift fa-bounce"></i> Surprise Box
    </a>

    <a href="{{ add_rev }}" class="{% if request.path == add_rev %}active{% endif %}"><i class="fa-solid fa-pen-fancy"></i> Create Review</a>
    <a href="{{ my_testi }}" class="{% if request.path == my_testi %}active{% endif %}"><i class="fa-solid fa-star"></i> My Reviews</a>
    <a href="{% url 'profile_settings' %}" class="{% if request.path == '/profile/' %}active{% endif %}">
        <i class="fa-solid fa-user-gear"></i> Profile Settings
    </a>
    <a href="{% url 'support_page' %}" class="{% if request.path == '/accounts/dashboard/support/' %}active{% endif %}">
        <i class="fa-solid fa-headset"></i> Support
    </a>
{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<div class="container-fluid px-4 py-4">
    <div class="text-center mb-5">
        <h2 class="fw-bold text-dark">üéÅ Mystery Surprise Box</h2>
        <p class="text-muted">Don't know what to eat? Let our AI Chef pick a premium meal for you!</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-5 col-md-8">
            {% if not winning_food %}
                <div class="card border-0 shadow-lg rounded-4 overflow-hidden text-center py-5" 
                     style="background: linear-gradient(145deg, #ffffff, #f8f9fa); border: 2px dashed #ffc107 !important;">
                    <div class="card-body">
                        <div class="mb-4 position-relative">
                            <img src="https://cdn-icons-png.flaticon.com/512/679/679821.png" 
                                 id="gift-box" class="img-fluid shake-animation" 
                                 width="180" style="cursor:pointer; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));">
                        </div>
                        
                        <h4 class="fw-bold mb-2">Something Delicious Awaits!</h4>
                        <div class="mb-4">
                            <span class="badge rounded-pill px-4 py-2 shadow-sm" style="background: #ff4b2b; font-size: 1.1rem;">
                                Fixed Price: ‡ß≥199
                            </span>
                        </div>

                        <div class="d-grid gap-2 col-9 mx-auto">
                            <button type="button" id="open-btn" class="btn btn-dark btn-lg rounded-pill shadow-sm py-3 fw-bold">
                                <i class="fa-solid fa-wand-magic-sparkles me-2 text-warning"></i>Reveal My Meal
                            </button>
                        </div>
                        
                        <p class="small text-muted mt-4 px-3">By clicking, you agree to order a random meal for ‡ß≥199.</p>
                        
                        <form method="POST" id="surprise-form">{% csrf_token %}</form>
                    </div>
                </div>
            {% else %}
                <div class="card border-0 shadow-lg rounded-4 overflow-hidden animate__animated animate__backInUp">
                    <div class="position-relative">
                        <img src="{{ winning_food.image.url }}" class="card-img-top" style="height:300px; object-fit:cover;">
                        <div class="position-absolute top-0 end-0 m-3">
                            <span class="badge bg-warning text-dark rounded-pill px-3 py-2 shadow fw-bold">‚ú® EXCLUSIVE DEAL</span>
                        </div>
                    </div>
                    
                    <div class="card-body p-4 text-center">
                        <h6 class="text-uppercase text-muted small fw-bold mb-2 ls-1">Congratulations! You got</h6>
                        <h2 class="fw-bold text-dark mb-3">{{ winning_food.name }}</h2>
                        
                        <div class="row g-0 bg-light rounded-4 overflow-hidden mb-4 border">
                            <div class="col-6 py-3 border-end">
                                <span class="d-block small text-muted">Original Price</span>
                                <span class="h5 mb-0 text-decoration-line-through text-danger">‡ß≥{{ winning_food.price }}</span>
                            </div>
                            <div class="col-6 py-3 bg-white">
                                <span class="d-block small text-muted">Your Price</span>
                                <span class="h5 mb-0 text-success fw-bold">‡ß≥199</span>
                            </div>
                        </div>

                        <div class="d-grid gap-3">
                            <a href="{% url 'add_to_cart' winning_food.id %}" class="btn btn-primary btn-lg rounded-pill shadow py-3 fw-bold">
                                <i class="fa-solid fa-cart-shopping me-2"></i>Add to Cart & Order
                            </a>
                            <a href="{% url 'surprise_box' %}" class="btn btn-link btn-sm text-decoration-none text-muted">
                                <i class="fa-solid fa-rotate-left me-1"></i>Try again?
                            </a>
                        </div>
                    </div>
                </div>
                <script>
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#ffc107', '#ff4b2b', '#28a745'] });
                </script>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Professional Animations */
    .shake-animation {
        animation: subtleShake 3s ease-in-out infinite;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .shake-animation:hover {
        transform: scale(1.1) rotate(5deg);
        animation: none;
    }

    @keyframes subtleShake {
        0%, 100% { transform: rotate(0deg); }
        5%, 15%, 25% { transform: rotate(-6deg); }
        10%, 20%, 30% { transform: rotate(6deg); }
        35% { transform: rotate(0deg); }
    }

    .ls-1 { letter-spacing: 1px; }

    .btn-primary {
        background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
        border: none;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
</style>

<script>
    const box = document.getElementById('gift-box');
    const btn = document.getElementById('open-btn');
    const form = document.getElementById('surprise-form');

    const handleReveal = () => {
        if(box) {
            box.style.transform = "scale(1.3) rotate(15deg)";
            box.style.filter = "brightness(1.5) drop-shadow(0 0 20px rgba(255,193,7,0.6))";
        }
        if(btn) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Revealing...';
            btn.classList.add('disabled');
        }
        setTimeout(() => form.submit(), 600);
    };

    if(box) box.onclick = handleReveal;
    if(btn) btn.onclick = handleReveal;
</script>
{% endblock %}